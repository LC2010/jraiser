/*!
 * jRaiser 2 Javascript Library
 * waterfall - v1.0.0 (2013-03-15T14:55:51+0800)
 * http://jraiser.org/ | Released under MIT license
 */
define("waterfall/1.0.x/",["base/1.0.x/","underscore/1.4.x/","tmpl/1.0.x/","dom/1.0.x/","widget/1.0.x/"],function(e,t,n){"use strict";function l(e,t){e.forEach(function(e){e.loaded||e.complete?t():e.onload=function(){this.onload=null,this.loaded=!0,t()}})}var r=e("base/1.0.x/"),i=e("underscore/1.4.x/"),s=e("tmpl/1.0.x/"),o=e("dom/1.0.x/"),u=e("widget/1.0.x/"),a=function(){var e=document.createElement("div"),t=["Webkit","Moz","O","MS"],n;if("transition"in e.style)n="";else for(var r=0;r<t.length;r++)if(t[r]+"Transition"in e.style){n=t[r];break}return e=null,n}(),f=a?a+"TransitionDuration":"transitionDuration";return u.create(function(e){},{_init:function(e){var t=this,n=e.wrapper,r=n.children();t._loadingPage=e.page||1,r.length||(r=null,t._loadingPage--),t._wrapper=n.css({overflow:"hidden",position:"relative"}),t._gridWidth=e.gridWidth||(r?r.outerWidth():0),t._rowSpacing=e.rowSpacing;var s=n.outerWidth(),u=parseInt(s/t._gridWidth);r&&(r.css("position","absolute"),a!=null&&r.css({left:s-t._gridWidth,right:"auto"})),t._colSpacing=(s-u*t._gridWidth)/(u-1),t._cols=new Array(u);for(var f=t._cols.length-1;f>=0;f--)t._cols[f]=0;t._checkMoreTrigger=i.debounce(function(){if(t._isDataLoading||t._isImgLoading||t._isEnd)return;var r=document.documentElement,i=(r.scrollTop||window.pageYOffset)+r.clientHeight,s=n.offset().top,o=n.outerHeight();if(i>=s+o)t.next();else if(e.prefetch&&!t._prefetchedData){var u=o-(/%$/.test(e.prefetch)?parseFloat(e.prefetch,10)/100*o:e.prefetch);i>=s+u&&t._loadNext(!0)}},50),o(window).on("scroll resize",t._checkMoreTrigger);if(r){t._isDataLoading=!0,t._renderingPage=1;var l=function(){t.trigger("render",{grids:r,page:t._renderingPage}),t._showGrids(r),t._isDataLoading=!1,r=null};a!=null?setTimeout(l,0):l()}else t._renderingPage=0},_destory:function(){var e=this;delete e._wrapper,delete e._gridWidth,delete e._rowSpacing,delete e._colSpacing,delete e._cols,delete e._isImgLoading,delete e._isDataLoading,delete e._isPrefetching,delete e._prefetchedData,delete e._isEnd,delete e._loadingPage,delete e._renderingPage,o(window).off("scroll resize",e._checkMoreTrigger),delete e._checkMoreTrigger},_loadNext:function(e){var t=this;if(t._isDataLoading||t._isEnd)return;var n=t.trigger("beforeload",{page:t._loadingPage+1,isPrefetch:e});if(n.isDefaultPrevented())return;t._isDataLoading=!0,t._isPrefetching=e,t._options.load.call(t,++t._loadingPage)},next:function(){this._prefetchedData?(this._add(this._prefetchedData),delete this._prefetchedData):this._loadNext()},minColIndex:function(){var e=this._cols;if(e){var t=0;for(var n=1;n<e.length;n++)e[n]<e[t]&&(t=n);return t}},_showGrids:function(e){var t=this,n=e.find("img"),r=e.length,i=-1,s=function(n){if(n!=null&&n>i){var s,o;for(var u=i+1;u<=n;u++)s=t.minColIndex(),o=e.eq(u),a!=null?o.css(f,"1s"):o.css("right","auto"),o.css({top:t._cols[s],left:(t._gridWidth+t._colSpacing)*s}),t._cols[s]+=o.outerHeight()+t._rowSpacing;t.trigger("imageload",{grids:e.slice(i,n)}),i=n,t._wrapper.height(Math.max.apply(Math,t._cols)),n>=r-1&&(t._isImgLoading=!1,t.trigger("allimagesload",{grids:e}),t._checkMoreTrigger())}};t._options.fixedImgSize?s(r-1):(t._isImgLoading=!0,l(n,function(){var t;e.each(function(e,n){if(i>=0&&n<=i)return;var r=!0,s=e.getElementsByTagName("img");for(var o=s.length-1;o>=0;o--){r=r&&(s[o].loaded||s[o].complete);if(!r)return r}t=n}),s(t)}))},_add:function(e){var t=this,n=t._cols.length-1,r=s.render(t._options.template,e);if(!r)return;var i=o(r).css("position","absolute");a!=null&&i.css({top:t._cols[n],left:(t._gridWidth+t._colSpacing)*n}),r=null,t._wrapper.append(i),t.trigger("render",{grids:i,page:++t._renderingPage});var u=0;i.forEach(function(e){var t=i.outerHeight();t>u&&(u=t)}),t._wrapper.css("height",(u+t._rowSpacing)*1.5+Math.max.apply(Math,t._cols)),t._showGrids(i)},completeLoading:function(e){var t=this;t.trigger("load",{data:e}),e&&(t._options.isEnd&&t._options.isEnd.call(t,e)?(t._isEnd=!0,t.trigger("end")):t._isPrefetching?(t._prefetchedData=e,t._checkMoreTrigger()):t._add(e)),t._isPrefetching=!1,t._isDataLoading=!1},clear:function(){if(this._wrapper){this._wrapper.empty().css("height",0);for(var e=this._cols.length-1;e>=0;e--)this._cols[e]=0}}},{fixedImgSize:!0,isEnd:function(e){return!e.data||!e.data.length}})})